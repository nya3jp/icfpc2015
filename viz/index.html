<html>

<script>

var ctx;

function determineStart(board, unit) {
  var unitRect = getUnitRect(unit, false);

  var unitWidth = unitRect.right - unitRect.left + 1;
  if (unitWidth % 2 == 0 && board.length % 2 == 0) {
    return {x: board.length / 2 - unitWidth / 2, y: -unitRect.top};
  } else if (unitWidth % 2 == 0) {
    return {x: (board.length - unitWidth - 1) / 2, y: -unitRect.top};
  } else if (board.length % 2 == 0) {
    return {x: (board.length - unitWidth - 1) / 2, y: -unitRect.top};
  } else {
    return {x: (board.length - unitWidth) / 2, y: -unitRect.top};
  }
}

function cloneUnit(unit) {
  var newUnit = {members: [], pivot: {}};
  for (var i = 0; i < unit.members.length; ++i) {
    newUnit.members.push({x: unit.members[i].x, y: unit.members[i].y});
  }
  newUnit.pivot.x = unit.pivot.x;
  newUnit.pivot.y = unit.pivot.y;
  return newUnit;
}

function moveUnit(unit, op) {
  for (var i = 0; i < unit.members.length; ++i) {
    op(unit.members[i]);
  }
  op(unit.pivot);
}

function rotateClockwise(position) {
  var xx = position.x - Math.floor(position.y / 2);
  var zz = position.y;
  var yy = -xx - zz;

  var tmp = xx;
  xx = -zz;
  zz = -yy;
  yy = -tmp;
  position.x = xx + Math.floor(zz / 2);
  position.y = zz;
}

function rotateCounterClockwise(position) {
  var xx = position.x - Math.floor(position.y / 2);
  var zz = position.y;
  var yy = -xx - zz;

  var tmp = xx;
  xx = -yy;
  yy = -zz;
  zz = -tmp;
  position.x = xx + Math.floor(zz / 2);
  position.y = zz;
}

function moveClockwise(origin, position) {
  var moved = {x: position.x - origin.x,
               y: position.y - origin.y};

  if ((origin.y & 1) && !(position.y & 1)) {
    moved.x -= 1;
  }

  rotateClockwise(moved);

  moved.x += origin.x;
  moved.y += origin.y;

  if ((origin.y & 1) && (!(moved.y & 1))) {
    moved.x += 1;
  }

  position.x = moved.x;
  position.y = moved.y;
}

function moveCounterClockwise(origin, position) {
  var moved = {x: position.x - origin.x,
               y: position.y - origin.y};

  if ((origin.y & 1) && !(position.y & 1)) {
    moved.x -= 1;
  }

  rotateCounterClockwise(moved);

  if ((origin.y & 1) && (!(moved.y & 1))) {
    moved.x += 1;
  }

  moved.x += origin.x;
  moved.y += origin.y;

  position.x = moved.x;
  position.y = moved.y;
}

function moveW(position) {
  position.x -= 1;
}

function moveSW(position) {
  if (position.y % 2 == 0) {
    position.x -= 1;
    position.y += 1;
  } else {
    position.y += 1;
  }
}

function moveSE(position) {
  if (position.y % 2 == 0) {
    position.y += 1;
  } else {
    position.x += 1;
    position.y += 1;
  }
}

function moveE(position) {
  position.x += 1;
}

function getUnitRect(unit, includePivot) {
  var members = unit.members;

  var right = 0;
  var top = Infinity;
  var left = Infinity;
  var bottom = 0;

  for (var j = 0; j < members.length; ++j) {
    right = Math.max(right, members[j].x);
    top = Math.min(top, members[j].y);
    left = Math.min(left, members[j].x);
    bottom = Math.max(bottom, members[j].y);
  }

  if (includePivot) {
    var pivot = unit.pivot;

    right = Math.max(right, pivot.x);
    top = Math.min(top, pivot.y);
    left = Math.min(left, pivot.x);
    bottom = Math.max(bottom, pivot.y);
  }

  return {top: top, right: right, left: left, bottom: bottom};
}

function drawUnits(units, r, gridMul, topLeft) {
  var margin = {x: 20, y: 20};

  var totalSize = {x: 0, y: 0};

  for (var i = 0; i < units.length; ++i) {
    var members = units[i].members;

    var width = 0;
    var height = 0;

    for (var j = 0; j < members.length; ++j) {
      width = Math.max(width, members[j].x);
      height = Math.max(height, members[j].y);
    }

    var pivot = units[i].pivot;

    width = Math.max(width, pivot.x);
    height = Math.max(height, pivot.y);

    width += 1;
    height += 1;

    var unitSize = coordToPosition({x: width, y: height}, r, gridMul);

    totalSize.x = Math.max(totalSize.x, unitSize.x);
    totalSize.y += unitSize.y;
  }

  ctx.strokeStyle = 'black';
  ctx.fillStyle = 'black';
  ctx.beginPath();
  ctx.rect(topLeft.x, topLeft.y, totalSize.x + margin.x * 2, totalSize.y + margin.y * 2);
  ctx.closePath();
  ctx.stroke();

  var top = margin.x;
  var left = margin.y;

  for (var i = 0; i < units.length; ++i) {
    var unit = units[i];

    var unitRect = getUnitRect(unit, true);

    var board = createBoard({x: unitRect.right + 1, y: unitRect.bottom + 1});

    putUnit(unit, board);

    drawBoard(board, r, gridMul, {x: topLeft.x + left, y: topLeft.y + top});

    top += coordToPosition({x: 0, y: unitRect.bottom + 1}, r, gridMul).y;
  }
}

function createBoard(size) {
  var board = [];
  for (var x = 0; x < size.x; ++x) {
    var col = [];
    for (var y = 0; y < size.y; ++y) {
      col.push(0);
    }
    board.push(col);
  }
  return board;
}

function init() {
  var canvas = document.getElementById('canvassample');
  ctx = canvas.getContext('2d');

  var problems = document.getElementById('problems');
  for (var i = 0; i < 23; ++i) {
    var file = 'problem_' + i + '.json';
    var option = document.createElement('option');
    option.value = file;
    option.innerText = file;
    problems.appendChild(option);
  }

  problems.addEventListener('change', function () {
    drawProblem(problems.options[problems.selectedIndex].value);
  });

  drawProblem(problems.options[problems.selectedIndex].value);

  document.body.addEventListener('keydown', function (e) {
    switch (e.keyCode) {
    case 'W'.charCodeAt(0):
      // Counter clockwise
      moveUnit(currentUnit, moveClockwise.bind(undefined, currentUnit.pivot));

      drawGame();
      break;
    case 'E'.charCodeAt(0):
      // Clockwise
      moveUnit(currentUnit, moveCounterClockwise.bind(undefined, currentUnit.pivot));

      drawGame();
      break;
    case 'A'.charCodeAt(0):
      // West
      moveUnit(currentUnit, moveW);

      drawGame();
      break;
    case 'Z'.charCodeAt(0):
      // South west
      moveUnit(currentUnit, moveSW);

      drawGame();
      break;
    case 'X'.charCodeAt(0):
      // South east
      moveUnit(currentUnit, moveSE);

      drawGame();
      break;
    case 'D'.charCodeAt(0):
      // East
      moveUnit(currentUnit, moveE);

      drawGame();
      break;
    }
  });
}

var currentBoard;

function cloneBoard(board) {
  var width = board.length;
  var height = board[0].length;

  var newBoard = [];

  for (var x = 0; x < width; ++x) {
    var col = [];
    for (var y = 0; y < height; ++y) {
      col.push(board[x][y]);
    }
    newBoard.push(col);
  }
  return newBoard;
}

var currentJson;
var currentUnit;

function drawGame() {
  ctx.clearRect(0, 0, 4000, 4000);

  var r = 15;
  var gridMul = 1.1;

  var margin = {x: 10, y: 10};

  var position = margin;

  var boardForDisplay = cloneBoard(currentBoard);

  if (currentUnit === undefined) {
    currentUnit = cloneUnit(currentJson.units[0]);
    var move = determineStart(boardForDisplay, currentUnit);
    console.log(move);
    moveUnit(currentUnit, function (position) { position.x += move.x; position.y += move.y; });
  }

  putUnit(currentUnit, boardForDisplay);

  drawBoard(boardForDisplay, r, gridMul, position);

  position.x += coordToPosition({x: currentJson.width, y: 0}, r, gridMul).x + 20;

  drawUnits(currentJson.units, r, gridMul, position);
}

function drawProblem(file) {
  var x = new XMLHttpRequest();
  x.open('GET', '../problems/' + file);
  x.responseType = 'json';
  x.onload = function () {
    var json = x.response;
    currentJson = json;

    currentUnit = undefined;
    currentBoard = createBoard({x: json.width, y: json.height});

    drawGame();
  };
  x.send();
}

function putUnit(unit, board) {
  var members = unit.members;

  var boardWidth = board.length;
  var boardHeight = board[0].length;

  for (var j = 0; j < members.length; ++j) {
    var x = members[j].x;
    var y = members[j].y;

    if (x < 0 || x >= boardWidth || y < 0 || y > boardHeight) {
      continue;
    }

    board[x][y] = board[x][y] | 1;
  }

  var pivot = unit.pivot;

  var x = pivot.x;
  var y = pivot.y;

  if (x < 0 || x >= boardWidth || y < 0 || y > boardHeight) {
    return;
  }

  board[x][y] = board[x][y] | 2;
}

function drawHex(cx, cy, r) {
  ctx.beginPath();
  for (var i = 0; i < 6; ++i) {
    var d = Math.PI / 6.0;
    ctx.lineTo(cx + r * Math.cos(d + Math.PI * i / 3.0), cy + r * Math.sin(d + Math.PI * i / 3.0));
  }
  ctx.closePath();
}

function coordToPosition(p, r, gridMul) {
  return {x: p.x * r * gridMul * 1.7 + r * Math.sqrt(3) / 2.0 * gridMul,
          y: p.y * r * gridMul * 1.5 + r * gridMul};
}

function drawBoard(board, r, gridMul, topLeft) {
  var height = board[0].length;
  var width = board.length;

  for (var x = 0; x < width; ++x) {
    for (var y = 0; y < height; ++y) {
      var position = coordToPosition({x: x, y: y}, r, gridMul)
      var cx = position.x + topLeft.x;
      var cy = position.y + topLeft.y;
      if (y % 2 == 1) {
        cx += r * Math.sqrt(3) / 2.0 * gridMul;
      }

      ctx.strokeStyle = 'black';
      ctx.fillStyle = 'black';
      drawHex(cx, cy, r);

      var data = board[x][y];
      if ((data & 1) == 1) {
        ctx.fill();
      } else {
        ctx.stroke();
      }

      if ((data & 2) == 2) {
        ctx.strokeStyle = 'gray';
        ctx.fillStyle = 'gray';
        drawHex(cx, cy, r * 0.4);
        ctx.fill();
      }
    }
  }
}
</script>

<body onload="init()">

<select id="problems"></select>

<canvas id="canvassample" width="4000" height="4000"></canvas>
